<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>المكتبة الصوتية الدعوية</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
:root {
  /* Light Theme (Default) */
  --primary-color: #1e3d59;
  --secondary-color: #17b794;
  --accent-color: #f5b461;
  --text-color: #2d4356;
  --text-color-light: #526d82;
  --background-color: #f5f5f7;
  --card-background: #ffffff;
  --border-color: #e8e8e8;
  --border-color-light: #f0f0f0;
  --placeholder-color: #bbb;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  --card-shadow: 0 4px 20px rgba(0,0,0,0.05);
  --card-shadow-hover: 0 10px 30px rgba(0,0,0,0.1);
  --header-gradient: linear-gradient(135deg, #1e3d59 0%, #102436 100%);
  --player-gradient: linear-gradient(90deg, #1e3d59, #152f45);
}

[data-theme="dark"] {
  --primary-color: #17b794;
  --secondary-color: #1e3d59;
  --accent-color: #f5b461;
  --text-color: #e4e6eb;
  --text-color-light: #b0b3b8;
  --background-color: #18191a;
  --card-background: #242526;
  --border-color: #393a3b;
  --border-color-light: #2f3031;
  --placeholder-color: #666;
  --card-shadow: 0 4px 20px rgba(0,0,0,0.2);
  --card-shadow-hover: 0 10px 30px rgba(0,0,0,0.3);
  --header-gradient: linear-gradient(135deg, #242526 0%, #18191a 100%);
  --player-gradient: linear-gradient(90deg, #242526, #18191a);
}

/* --- Global Styles & Resets --- */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: "Tajawal", "Arial", sans-serif;
  background-color: var(--background-color);
  color: var(--text-color);
  margin: 0;
  padding: 0;
  direction: rtl;
  text-align: right;
  font-size: 16px; /* Base font size */
}

/* --- Utility Classes --- */
.visually-hidden {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

/* --- Animations --- */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes shimmer {
  0% { background-position: -1000px 0; }
  100% { background-position: 1000px 0; }
}

@keyframes fadeInScale {
  0% { opacity: 0; transform: translateY(20px) scale(0.9); }
  100% { opacity: 1; transform: translateY(0) scale(1); }
}

@keyframes float {
  0% { transform: translateY(0px); }
  50% { transform: translateY(-5px); }
  100% { transform: translateY(0px); }
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

@keyframes slideInRight {
  0% { transform: translateX(30px); opacity: 0; }
  100% { transform: translateX(0); opacity: 1; }
}

@keyframes slideInLeft {
  0% { transform: translateX(-30px); opacity: 0; }
  100% { transform: translateX(0); opacity: 1; }
}

/* --- Theme Toggle --- */
.theme-toggle {
  position: absolute;
  top: 1rem;
  left: 1rem;
}

.theme-btn {
  background: transparent;
  border: none;
  color: white;
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0.5rem;
  border-radius: 50%;
  transition: var(--transition);
}

.theme-btn:hover {
  transform: rotate(30deg);
}

/* --- Header --- */
header {
  background: var(--header-gradient);
  color: white;
  padding: 2.5rem 1.5rem;
  box-shadow: 0 5px 25px rgba(0,0,0,0.2);
  position: relative;
}

.logo.logo-option-2 {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  margin: 0 auto 2rem;
  max-width: 800px;
  padding: 0 1rem;
  animation: fadeIn 0.9s ease-out;
}

.logo.logo-option-2 i {
  font-size: 4rem;
  color: var(--accent-color);
  filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3));
  margin-bottom: 0.8rem;
}

.logo.logo-option-2 h1 {
  font-size: 2.8rem;
  font-weight: 700;
  letter-spacing: 0.5px;
  text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.5);
  margin: 0 0 0.2rem 0;
  line-height: 1.3;
  color: white;
  min-height: 3.8rem; /* للحفاظ على مساحة ثابتة أثناء الكتابة */
}

.logo.logo-option-2 .en-title {
  font-size: 2.2rem;
  font-weight: 600;
  font-family: 'Roboto', sans-serif;
  opacity: 0.9;
  margin-top: 0;
  margin-bottom: 0.5rem;
}

/* تأثير الكتابة - الكرسور المتحرك */
.typed-cursor {
  opacity: 1;
  animation: typedjsBlink 0.7s infinite;
  color: var(--accent-color);
}

@keyframes typedjsBlink {
  50% { opacity: 0.0; }
}

.logo.logo-option-2 .tagline {
  font-size: 1rem;
  font-weight: 400;
  color: rgba(255, 255, 255, 0.85);
  margin: 0;
  padding: 0;
  letter-spacing: 0.5px;
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}

/* --- Search & Filters --- */
.search-section {
  max-width: 800px;
  margin: 0 auto;
}

.search-bar {
  position: relative;
  margin-bottom: 1rem;
}

.search-bar i {
  position: absolute;
  right: 1rem;
  top: 50%;
  transform: translateY(-50%);
  color: rgba(255,255,255,0.6);
  font-size: 1rem;
  pointer-events: none; /* Prevent icon interfering with input */
}

.search-bar input {
  width: 100%;
  padding: 0.8rem 3rem 0.8rem 1rem;
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 8px;
  font-size: 1rem;
  background: rgba(255,255,255,0.1);
  color: white;
  transition: var(--transition);
}

.search-bar input::placeholder {
  color: rgba(255,255,255,0.6);
}

.search-bar input:focus {
  outline: none;
  border-color: var(--accent-color);
  background: rgba(255,255,255,0.15);
  box-shadow: 0 0 0 3px rgba(251, 176, 59, 0.3);
}

.filters {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  /* Removed background/border for cleaner look, relies on selects */
  padding: 0.5rem 0; /* Reduced padding */
  margin: 1rem auto 0;
  justify-content: center;
}

.filters select {
  appearance: none;
  background: rgba(255,255,255,0.15);
  color: white;
  padding: 0.7rem 2.5rem 0.7rem 1rem;
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: 8px;
  font-size: 0.9rem;
  cursor: pointer;
  transition: all 0.2s ease-in-out;
  position: relative;
  min-width: 150px;
  text-align: right; /* Align text right for RTL */
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: left 0.7rem center; /* Icon on the left */
  background-size: 1rem;
}

.filters select:hover {
  background-color: rgba(255,255,255,0.25);
  transform: translateY(-1px);
}

.filters select:focus {
  outline: none;
  border-color: var(--accent-color);
  box-shadow: 0 0 0 3px rgba(251, 176, 59, 0.3);
}

.filters select option {
  background-color: var(--primary-color);
  color: white;
}

/* --- Category Buttons Navigation --- */
.categories {
  padding: 1.2rem 1.5rem;
  display: flex;
  justify-content: center;
  gap: 1rem;
  flex-wrap: wrap;
  background-color: var(--card-background);
  box-shadow: 0 3px 10px rgba(0,0,0,0.08);
  border-bottom: 1px solid var(--border-color-light);
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(8px);
}

.category-btn {
  padding: 0.9rem 1.6rem;
  border: 1px solid var(--border-color);
  border-radius: 30px;
  background-color: var(--card-background);
  font-weight: 600;
  letter-spacing: 0.5px;
  color: var(--text-color);
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  font-size: 1rem;
  display: inline-flex; /* Align icon and text */
  align-items: center;
  gap: 0.7rem;
  position: relative;
  overflow: hidden;
}

.category-btn::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 0;
  background: linear-gradient(to top, var(--secondary-color), transparent);
  opacity: 0.1;
  transition: height 0.3s ease;
  z-index: -1;
}

.category-btn i {
  color: var(--secondary-color); /* Icon color */
  font-size: 1em;
  transition: transform 0.3s ease;
}

.category-btn:hover {
  background-color: var(--background-color);
  border-color: var(--secondary-color);
  transform: translateY(-3px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

.category-btn:hover::after {
  height: 100%;
}

.category-btn:hover i {
  transform: scale(1.2);
}

.category-btn.active {
  background-color: var(--secondary-color);
  color: white;
  border-color: var(--secondary-color);
  box-shadow: 0 5px 15px rgba(23, 183, 148, 0.4);
  transform: translateY(-2px) scale(1.05);
}

.category-btn.active i {
  color: white; /* Icon color when active */
  transform: scale(1.1);
}

.category-btn.active::after {
  height: 0;
}

.category-btn:focus {
  outline: 2px solid var(--accent-color);
  outline-offset: 2px;
  box-shadow: 0 0 0 3px rgba(251, 176, 59, 0.3);
}

/* --- Main Content Area --- */
main {
    padding: 0 1.5rem; /* Padding for content grid */
}

.grid-container {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 1.5rem;
  padding: 2rem 0; /* Padding moved from main */
}

/* --- Skeleton Loaders --- */
#loading.skeleton-active {
    display: grid; /* Use grid like the container */
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
    padding: 2rem 0;
}
.skeleton-card {
    background-color: var(--card-background);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: var(--card-shadow);
    border: 1px solid var(--border-color);
    position: relative;
    overflow: hidden;
}
.skeleton-line {
    background: linear-gradient(to right, var(--placeholder-color) 8%, #dddddd 18%, var(--placeholder-color) 33%);
    background-size: 1000px 100%; /* Large size for shimmer */
    animation: shimmer 1.5s infinite linear;
    height: 1.2em;
    border-radius: 4px;
    margin-bottom: 0.8em;
}
.skeleton-line.title { height: 1.5em; width: 70%; margin-bottom: 1.5em; }
.skeleton-line.short { width: 50%; }
.skeleton-line.meta { height: 1em; width: 60%; margin-bottom: 0.6em; }
.skeleton-line.button { height: 40px; width: 48%; display: inline-block; margin-top: 1.5em; margin-left: 4%; }
.skeleton-line.button:first-child { margin-left: 0; }


/* --- Empty State --- */
.empty-state {
    text-align: center;
    padding: 4rem 1rem;
    color: var(--text-color-light);
    grid-column: 1 / -1; /* Span full grid width */
}
.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: var(--placeholder-color);
}
.empty-state p {
    font-size: 1.1rem;
}

/* --- Audio Card --- */
.card {
  background: var(--card-background);
  border-radius: 16px;
  padding: 1.8rem;
  box-shadow: var(--card-shadow);
  border: 1px solid var(--border-color);
  backdrop-filter: blur(10px);
  position: relative;
  display: flex;
  flex-direction: column;
  gap: 0.8rem;
  opacity: 0;
  transform: translateY(15px);
  overflow: hidden; /* For border */
  border-right: 5px solid transparent; /* Category Indicator */
  transition: opacity 0.4s ease-out, transform 0.4s ease-out, box-shadow 0.3s ease, border-color 0.3s ease;
}
.card:hover {
  transform: translateY(-5px);
  box-shadow: var(--card-shadow-hover);
}

/* Category Colors */
.card.category-خطب { border-right-color: #3498DB; }
.card.category-محاضرات { border-right-color: #2ECC71; }
.card.category-تلاوات { border-right-color: #F39C12; }
.card.category-دروس { border-right-color: #9B59B6; }
/* Add more category colors if needed */
.card.category- { border-right-color: #bdc3c7; } /* Default for undefined */


/* Card Content */
.card h2 {
  margin: 0 0 0.8rem;
  font-size: 1.2rem;
  color: var(--primary-color);
  line-height: 1.45;
  font-weight: 700;
}

.card .card-meta {
  display: flex;
  flex-direction: column;
  gap: 0.7rem;
  margin-bottom: 1rem;
}

.card p {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  color: var(--text-color-light);
  margin: 0;
  font-size: 0.9rem;
}

.card p i {
  color: var(--secondary-color);
  font-size: 1rem;
  width: 1.3em;
  text-align: center;
  flex-shrink: 0;
}
.card p i.fa-clock { color: #e74c3c; } /* Different color for duration */
.card p i.fa-user-tie { color: #8e44ad; } /* Different color for speaker */


.audio-controls {
  display: flex;
  gap: 1rem;
  margin-top: auto; /* Push controls to bottom */
  padding-top: 1rem;
  border-top: 1px solid var(--border-color-light);
}

.play-btn, .share-btn, .download-btn {
  flex: 1;
  padding: 0.8rem;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease-in-out;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.6rem;
  font-size: 0.95rem;
  text-decoration: none; /* For download link */
}
.play-btn i, .download-btn i {
    font-size: 1em; /* Ensure icon size matches text */
}

.play-btn {
  background-color: var(--primary-color);
  color: white;
}
.play-btn:hover {
  background-color: #1a3f5c;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(35, 78, 112, 0.2);
}
.play-btn:disabled {
    background-color: #a0b4c2;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* Outlined Download Button */
.download-btn {
  background-color: var(--primary-color);
  color: white;
  border: none;
}
.download-btn:hover {
  background-color: #1a3f5c;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(35, 78, 112, 0.2);
}
.download-btn.disabled {
    background-color: transparent;
    color: var(--placeholder-color);
    border-color: var(--placeholder-color);
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}


/* Playing State on Card */
.card.is-playing {
  border-color: var(--accent-color); /* Highlight border */
  box-shadow: 0 6px 20px rgba(251, 176, 59, 0.3); /* Accent shadow */
}
.card.is-playing .play-btn {
  background-color: var(--secondary-color); /* Change color to indicate playing */
}
/* JS will handle changing the icon class to fa-pause or fa-volume-up */


/* Focus states for buttons */
.play-btn:focus, .download-btn:focus {
    outline: 2px solid var(--accent-color);
    outline-offset: 2px;
    box-shadow: 0 0 0 3px rgba(251, 176, 59, 0.3);
}

/* --- Audio Player Styles --- */
#audio-player-container {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--player-gradient);
  color: white;
  padding: 0.8rem 1.2rem; /* Increased padding */
  box-shadow: 0 -8px 30px rgba(0,0,0,0.2);
  z-index: 1000;
  backdrop-filter: blur(10px);
  height: auto;
  min-height: 80px;
  display: flex;
  align-items: center;
  transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
  transform: translateY(100%); /* Start hidden */
  border-top: 1px solid rgba(255,255,255,0.1);
}

#audio-player-container:not(.hidden) {
  transform: translateY(0); /* Show */
  animation: slide-up 0.5s cubic-bezier(0.19, 1, 0.22, 1);
}

@keyframes slide-up {
  0% { transform: translateY(100%); }
  100% { transform: translateY(0); }
}

#audio-player-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 4px;
  background: linear-gradient(90deg, var(--accent-color), var(--secondary-color));
  opacity: 0.7;
}

.player-content {
  display: flex;
  align-items: center;
  gap: 1rem; /* Adjusted gap */
  max-width: 1200px;
  margin: 0 auto;
  width: 100%;
}

.player-info {
  min-width: 150px;
  flex-shrink: 1;
  overflow: hidden;
  text-align: right;
}
.player-info h3 {
  font-size: 0.95rem;
  margin: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-weight: 700;
}
.player-info p {
  font-size: 0.75rem;
  margin: 2px 0 0;
  opacity: 0.8;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: rgba(255,255,255,0.8); /* Ensure light color */
}

/* Player Controls Layout */
.player-controls {
  flex: 2;
  display: flex;
  align-items: center;
  gap: 1rem;
}

/* Progress Bar Area */
.progress-wrapper {
    flex-grow: 1;
    position: relative;
    padding: 10px 0; /* Space for time labels */
}
.progress-container {
  width: 100%;
  height: 6px; /* Slightly thicker */
  background: rgba(255,255,255,0.15);
  border-radius: 3px;
  cursor: pointer;
  position: relative;
}
#progress-bar {
  height: 100%;
  background: var(--accent-color);
  border-radius: 3px;
  width: 0;
  transition: width 0.1s linear;
  position: relative;
}
#progress-bar::after {
    content: '';
    position: absolute;
    right: 0; /* For RTL */
    top: 50%;
    transform: translate(50%, -50%);
    width: 14px; /* Larger thumb */
    height: 14px;
    background-color: var(--accent-color);
    border-radius: 50%;
    box-shadow: 0 0 5px rgba(0,0,0,0.3);
    opacity: 0;
    transition: opacity 0.2s ease;
}
.progress-container:hover #progress-bar::after {
    opacity: 1;
}

#current-time, #duration {
  position: absolute;
  top: -5px;
  font-size: 0.75rem;
  color: rgba(255,255,255,0.8);
  background: rgba(0,0,0,0.2);
  padding: 1px 4px;
  border-radius: 3px;
  user-select: none; /* Prevent selecting time */
}
#current-time { right: 0; }
#duration { left: 0; }

/* Control Buttons Area */
.controls-wrapper {
    display: flex;
    align-items: center;
    gap: 0.8rem;
}

.control-buttons {
  display: flex;
  gap: 0.8rem;
}
.control-btn {
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  color: white;
  font-size: 1rem;
  cursor: pointer;
  padding: 0.5rem;
  border-radius: 50%;
  transition: all 0.2s ease-in-out;
  width: 38px;
  height: 38px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.control-btn:hover {
  background: rgba(255,255,255,0.25);
  transform: scale(1.1);
}
.control-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
    background: rgba(255,255,255,0.1);
}
.control-btn:focus {
    outline: 2px solid var(--accent-color);
    outline-offset: 2px;
    box-shadow: 0 0 0 3px rgba(251, 176, 59, 0.3);
}

/* Volume Control */
.volume-control {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
#volume-slider {
    appearance: none;
    width: 70px; /* Adjust width */
    height: 5px;
    background: rgba(255,255,255,0.2);
    border-radius: 3px;
    cursor: pointer;
    transition: opacity 0.2s ease;
    opacity: 0.7; /* Slightly transparent when not hovered */
}
#volume-slider:hover {
    opacity: 1;
}

/* Volume Slider Thumb */
#volume-slider::-webkit-slider-thumb {
    appearance: none;
    width: 14px;
    height: 14px;
    background: white;
    border-radius: 50%;
    cursor: pointer;
}
#volume-slider::-moz-range-thumb {
    width: 14px;
    height: 14px;
    background: white;
    border-radius: 50%;
    cursor: pointer;
    border: none;
}

/* Close Player Button (Optional) */
#close-player-btn {
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    font-size: 1.2rem;
    padding: 0.3rem;
    cursor: pointer;
    margin-right: auto; /* Push to the far right */
    line-height: 1;
}
#close-player-btn:hover {
    color: white;
}


/* --- Footer --- */
footer {
  background-color: var(--primary-color);
  color: rgba(255, 255, 255, 0.8); /* Softer white */
  padding: 2.5rem 1.5rem;
  margin-top: 2rem;
  text-align: center; /* Center footer content */
}

.radio-section {
  max-width: 850px;
  margin: 2.5rem auto;
  text-align: center;
  padding: 1.5rem;
  background: var(--card-background);
  border-radius: 16px;
  box-shadow: var(--card-shadow);
  position: relative;
  overflow: hidden;
  border: 1px solid var(--border-color);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.radio-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 5px;
  background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
}

.radio-section:hover {
  transform: translateY(-5px);
  box-shadow: var(--card-shadow-hover);
}

.radio-section h3 {
  margin-bottom: 1.5rem;
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--primary-color);
  position: relative;
  display: inline-block;
}

.radio-section h3::after {
  content: '';
  position: absolute;
  bottom: -10px;
  left: 50%;
  transform: translateX(-50%);
  width: 50px;
  height: 3px;
  background: var(--accent-color);
  border-radius: 3px;
}

.radio-section iframe {
  width: 100%;
  max-width: 700px;
  height: 250px;
  border-radius: 12px;
  border: 1px solid var(--border-color);
  box-shadow: 0 6px 16px rgba(0,0,0,0.12);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.radio-section iframe:hover {
  transform: scale(1.01);
  box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

/* مؤثر متحرك للإشارة إلى وجود بث مباشر */
.radio-section h3::before {
  content: '';
  display: inline-block;
  width: 12px;
  height: 12px;
  background-color: #ff4c4c;
  border-radius: 50%;
  margin-left: 10px;
  animation: pulse-red 2s infinite;
}

@keyframes pulse-red {
  0% {
    transform: scale(0.95);
    box-shadow: 0 0 0 0 rgba(255, 76, 76, 0.7);
  }
  
  70% {
    transform: scale(1);
    box-shadow: 0 0 0 10px rgba(255, 76, 76, 0);
  }
  
  100% {
    transform: scale(0.95);
    box-shadow: 0 0 0 0 rgba(255, 76, 76, 0);
  }
}

.footer-info {
    font-size: 0.9rem;
}


/* --- Responsive Adjustments --- */
@media (max-width: 992px) {
    .player-info { min-width: 120px; }
}

@media (max-width: 768px) {
  header { padding: 2rem 1rem; }
  .logo.logo-option-2 i { font-size: 3.5rem; }
  .logo.logo-option-2 h1 { font-size: 2.3rem; }
  .logo.logo-option-2 .tagline { font-size: 0.9rem; }

  .filters {
    flex-direction: column;
    width: 100%;
    padding: 0.8rem 0;
    align-items: stretch;
  }
  .filters select {
    width: 100%;
    max-width: none;
  }

  main { padding: 0 1rem; }
  .grid-container, #loading.skeleton-active {
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      padding: 1.5rem 0;
  }

  .card { padding: 1rem; }
  .card h2 { font-size: 1.1rem; }
  .card p { font-size: 0.85rem; }
  .play-btn, .download-btn { padding: 0.7rem; font-size: 0.9rem; }

  /* Player Adjustments */
  #audio-player-container { height: auto; min-height: 70px; padding: 0.5rem 0.8rem; }
  .player-content { gap: 0.8rem; }
  .player-info h3 { font-size: 0.9rem; }
  .player-info p { font-size: 0.7rem; }
  .player-controls { gap: 0.8rem; }
  .controls-wrapper { gap: 0.5rem; }
  .control-buttons { gap: 0.5rem; }
  .control-btn { width: 35px; height: 35px; font-size: 0.9rem; }
  .volume-control { display: none; } /* Hide volume slider on smaller tablets */
}

@media (max-width: 480px) {
  body { font-size: 15px; }
  header { padding: 1.5rem 1rem; }
  .logo.logo-option-2 i { font-size: 3rem; margin-bottom: 0.5rem;}
  .logo.logo-option-2 h1 { font-size: 2rem; }
  .logo.logo-option-2 .tagline { font-size: 0.8rem; }

  .search-bar input { font-size: 0.9rem; padding: 0.7rem 2.5rem 0.7rem 0.8rem; }
  .search-bar i { right: 0.8rem; font-size: 0.9rem;}

  .categories { padding: 0.8rem 1rem; gap: 0.5rem;}
  .category-btn { padding: 0.5rem 1rem; font-size: 0.85rem; }

  main { padding: 0 0.5rem; }
  .grid-container, #loading.skeleton-active { grid-template-columns: 1fr; gap: 1rem; padding: 1rem 0;}
  .card h2 { font-size: 1.05rem; }

  /* Player Stacking */
  #audio-player-container { padding-bottom: 10px; } /* Extra padding bottom */
  .player-content { flex-direction: column; align-items: stretch; text-align: center; gap: 0.5rem; }
  .player-info { text-align: center; min-width: 0; }
  .player-controls { flex-direction: column; gap: 0.5rem; }
  .progress-wrapper { padding: 5px 0; width: 100%; order: -1; } /* Move progress to top */
  #current-time, #duration { top: -15px; }
  .controls-wrapper { justify-content: center; width: 100%;}
  .volume-control { display: none; } /* Ensure hidden */
  #close-player-btn { position: absolute; top: 5px; left: 10px; } /* Reposition close */

  footer { padding: 2rem 1rem; }
  .radio-section h3 { font-size: 1.3rem; }
  .radio-section iframe { height: 150px; }
  .footer-info { font-size: 0.8rem; }
}
  </style>
</head>
<body>
  <header>
    <!-- Logo Option 2: Icon + Title + Tagline -->
    <div class="logo logo-option-2">
      <i class="fas fa-mosque"></i>
      <h1 id="typed-heading"></h1>
      <h1 id="typed-heading-en" class="en-title"></h1>
      <p class="tagline" id="typed-tagline"></p>
    </div>

    <!-- Search & Filters -->
    <div class="theme-toggle">
  <button id="theme-toggle-btn" class="theme-btn" aria-label="تبديل المظهر">
    <i class="fas fa-sun"></i>
  </button>
</div>
<div class="search-section">
      <div class="search-bar">
        <i class="fas fa-search"></i>
        <input type="text" id="search" placeholder="ابحث عن عنوان، شيخ، موضوع...">
      </div>

      <div class="filters">
        <select id="districtFilter" aria-label="فلتر حسب المديرية">
          <option value="">كل المديريات</option>
          <!-- Options added dynamically -->
        </select>
        <select id="mosqueFilter" aria-label="فلتر حسب المسجد">
          <option value="">كل المساجد</option>
          <!-- Options added dynamically -->
        </select>
        <select id="dateFilter" aria-label="فلتر حسب التاريخ">
          <option value="">كل التواريخ</option>
          <option value="week">آخر أسبوع</option>
          <option value="month">آخر شهر</option>
          <option value="year">آخر سنة</option>
        </select>
      </div>
    </div>
  </header>

  <!-- Category Buttons Navigation -->
  <nav class="categories" aria-label="تصفح حسب القسم">
    <button class="category-btn active" data-category="all"><i class="fas fa-list"></i> الكل</button>
    <button class="category-btn" data-category="خطب"><i class="fas fa-mosque"></i> خطب</button>
    <button class="category-btn" data-category="محاضرات"><i class="fas fa-microphone-alt"></i> محاضرات</button>
    <button class="category-btn" data-category="تلاوات"><i class="fas fa-quran"></i> تلاوات</button>
    <button class="category-btn" data-category="دروس"><i class="fas fa-book-open"></i> دروس</button>
  </nav>

  <div class="whatsapp-section">
    <h2 class="whatsapp-title">شارك معنا في نشر العلم والخير</h2>
    <a href="https://wa.me/775960910" class="whatsapp-btn" target="_blank" rel="noopener noreferrer">
      <i class="fab fa-whatsapp"></i>
      <span>تواصل معنا عبر واتساب</span>
    </a>
    <p class="whatsapp-text">نرحب بمشاركاتكم القيمة من خطب ومحاضرات ودروس وتلاوات عطرة، فهذا من التعاون على البر والتقوى الذي أمرنا به الله. إن مساهماتكم الفعالة هي أساس نجاح هذا المشروع الدعوي، وتعزز أواصر الأخوة بين الدعاة إلى الله في مختلف مديريات شبوة، وتزيد من التعارف والتآلف بينهم. فلنكن يداً واحدة في نشر العلم النافع وتبليغ دين الله، ولنجعل من هذا المنبر جسراً للتواصل وصرحاً للدعوة والإرشاد</p>
  </div>

  <div class="radio-section">
    <h3>البث المباشر لإذاعة السلام</h3>
    <iframe src="https://radioalsalam.mixlr.com/events/4158647" frameborder="0" title="البث المباشر لإذاعة السلام"></iframe>
  </div>

  <main>
    <!-- Skeleton Loaders Area -->
    <div id="loading" class="skeleton-active">
        <!-- Skeleton cards will be generated by JS -->
    </div>
    <!-- Content Grid Area -->
    <div id="content" class="grid-container" aria-live="polite">
        <!-- Audio cards will be loaded here -->
    </div>
  </main>

  <!-- Audio Player -->
  <div id="audio-player-container" class="hidden" role="region" aria-label="مشغل الصوت">
    <button id="close-player-btn" class="control-btn" aria-label="إغلاق المشغل">
        <i class="fas fa-times"></i>
    </button>
    <div class="player-content">
      <div class="player-info">
        <h3 id="current-audio-title" aria-live="polite"></h3>
        <p id="current-audio-center" aria-live="polite"></p>
      </div>
      <div class="player-controls">
         <div class="progress-wrapper">
            <div class="progress-container" role="slider" aria-label="شريط التقدم" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" tabindex="0">
              <div id="progress-bar"></div>
            </div>
            <span id="current-time" aria-hidden="true">0:00</span>
            <span id="duration" aria-hidden="true">0:00</span>
         </div>
         <div class="controls-wrapper">
            <div class="control-buttons">
              <button id="backward-btn" class="control-btn" aria-label="رجوع 10 ثواني">
                <i class="fas fa-backward-step"></i>
              </button>
              <button id="play-pause-btn" class="control-btn" aria-label="تشغيل">
                <i class="fas fa-play"></i>
              </button>
              <button id="forward-btn" class="control-btn" aria-label="تقديم 10 ثواني">
                <i class="fas fa-forward-step"></i>
              </button>
              <button id="download-btn-player" class="control-btn" aria-label="تحميل المقطع الحالي">
                <i class="fas fa-download"></i>
              </button>
            </div>
            <div class="volume-control">
                <button id="mute-btn" class="control-btn" aria-label="كتم الصوت">
                    <i class="fas fa-volume-up"></i> <!-- Initial icon -->
                </button>
                <input type="range" id="volume-slider" min="0" max="100" value="100" aria-label="التحكم بمستوى الصوت">
            </div>
         </div>
        <audio id="main-audio-player" preload="metadata"></audio>
      </div>
    </div>
  </div>

  <footer>
    <div class="footer-info">
      <p>&copy; <span id="current-year"></span> المكتبة الصوتية الدعوية. جميع الحقوق محفوظة.</p>
    </div>
  </footer>

  <style>
    .whatsapp-section {
      text-align: center;
      padding: 2.5rem 1.5rem;
      background: var(--card-background);
      margin: 1.5rem auto 2.5rem;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      position: relative;
      overflow: hidden;
      max-width: 900px;
      border: 1px solid var(--border-color);
    }
    
    .whatsapp-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 6px;
      background: linear-gradient(90deg, #25D366, #128C7E);
    }

    .whatsapp-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.8rem;
      background-color: #25D366;
      color: white;
      padding: 1.2rem 2.5rem;
      border-radius: 50px;
      text-decoration: none;
      font-size: 1.3rem;
      font-weight: 700;
      margin: 0.5rem auto 1.5rem;
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
      position: relative;
      z-index: 2;
    }

    .whatsapp-btn:hover {
      transform: translateY(-5px) scale(1.03);
      box-shadow: 0 10px 25px rgba(37, 211, 102, 0.5);
    }
    
    .whatsapp-btn:active {
      transform: translateY(0) scale(0.98);
      box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
    }

    .whatsapp-btn i {
      font-size: 1.7rem;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    .whatsapp-text {
      color: var(--text-color);
      font-size: 1.15rem;
      line-height: 1.8;
      max-width: 750px;
      margin: 1rem auto 0;
      padding: 0 1rem;
      text-align: justify;
      text-align-last: center;
    }
    
    .whatsapp-title {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 1.5rem;
    }
    
    /* تحسين مظهر بطاقات الصوتيات */
    .card {
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), 
                  box-shadow 0.3s ease, 
                  border-color 0.3s ease, 
                  opacity 0.4s ease-out;
      will-change: transform, box-shadow;
    }
    
    .card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: var(--card-shadow-hover);
      z-index: 5;
    }
    
    .card.is-playing {
      animation: glow 2s infinite alternate;
    }
    
    @keyframes glow {
      from { box-shadow: 0 0 5px rgba(251, 176, 59, 0.5); }
      to { box-shadow: 0 0 20px rgba(251, 176, 59, 0.8); }
    }
    
    .play-btn, .share-btn, .download-btn {
      transform: translateY(0);
      transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), 
                  background-color 0.2s ease, 
                  box-shadow 0.2s ease;
    }
    
    .play-btn:hover, .share-btn:hover, .download-btn:hover {
      transform: translateY(-3px);
    }
    
    .play-btn:active, .share-btn:active, .download-btn:active {
      transform: translateY(0) scale(0.98);
    }

    @media (max-width: 768px) {
      .whatsapp-section {
        padding: 2rem 1rem;
        margin: 1rem auto 2rem;
      }
      
      .whatsapp-title {
        font-size: 1.4rem;
      }
      
      .whatsapp-btn {
        padding: 1rem 2rem;
        font-size: 1.2rem;
      }
      
      .whatsapp-text {
        font-size: 1rem;
        line-height: 1.6;
      }
    }

    @media (max-width: 480px) {
      .whatsapp-title {
        font-size: 1.3rem;
      }
      
      .whatsapp-btn {
        padding: 0.8rem 1.5rem;
        font-size: 1.1rem;
        width: 90%;
        max-width: 300px;
      }
      
      .whatsapp-text {
        font-size: 0.95rem;
        text-align: right;
        text-align-last: auto;
        padding: 0;
      }
    }
  </style>

  <!-- إضافة مكتبة Typed.js لتأثير الكتابة -->
  <script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12"></script>
  <script>
    // --- تهيئة تأثير الكتابة للعنوان ---
    document.addEventListener('DOMContentLoaded', function() {
      // العنوان العربي
      new Typed('#typed-heading', {
        strings: ['المكتبة الصوتية الدعوية'],
        typeSpeed: 80,
        backSpeed: 50,
        startDelay: 300,
        showCursor: true,
        cursorChar: '|',
        loop: false,
        onComplete: function(self) {
          // إخفاء المؤشر عند الانتهاء
          document.querySelector('.typed-cursor').style.display = 'none';
          
          // بدء العنوان الإنجليزي بعد اكتمال العربي
          setTimeout(function() {
            new Typed('#typed-heading-en', {
              strings: ['Da\'wah Audio Library'],
              typeSpeed: 80,
              backSpeed: 50,
              startDelay: 100,
              showCursor: true,
              cursorChar: '|',
              loop: false,
              onComplete: function(self) {
                // إخفاء المؤشر الثاني عند الانتهاء
                document.querySelectorAll('.typed-cursor')[1].style.display = 'none';
                
                // بدء الوصف بعد اكتمال العنوانين
                setTimeout(function() {
                  new Typed('#typed-tagline', {
                    strings: ['كنوز من المواعظ والدروس والتلاوات', 'Treasures of sermons, lessons and recitations'],
                    typeSpeed: 70,
                    backSpeed: 40,
                    startDelay: 100,
                    showCursor: false, // إخفاء المؤشر نهائيًا
                    backDelay: 2000,
                    loop: true,
                    loopCount: Infinity
                  });
                }, 500);
              }
            });
          }, 500);
        }
      });
    });

    // --- DOM Element References ---
    const content = document.getElementById('content');
    const loadingContainer = document.getElementById('loading');
    const audioPlayer = document.getElementById('main-audio-player');
    const playerContainer = document.getElementById('audio-player-container');
    const playPauseBtn = document.getElementById('play-pause-btn');
    const downloadBtnPlayer = document.getElementById('download-btn-player');
    const progressBar = document.getElementById('progress-bar');
    const currentTimeSpan = document.getElementById('current-time');
    const durationSpan = document.getElementById('duration');
    const progressContainer = document.querySelector('.progress-container');
    const districtFilter = document.getElementById('districtFilter');
    const mosqueFilter = document.getElementById('mosqueFilter');
    const dateFilter = document.getElementById('dateFilter');
    const searchInput = document.getElementById('search');
    const categoryButtons = document.querySelectorAll('.category-btn');
    const currentAudioTitle = document.getElementById('current-audio-title');
    const currentAudioCenter = document.getElementById('current-audio-center');
    const forwardBtn = document.getElementById('forward-btn');
    const backwardBtn = document.getElementById('backward-btn');
    const closePlayerBtn = document.getElementById('close-player-btn');
    const volumeSlider = document.getElementById('volume-slider');
    const muteBtn = document.getElementById('mute-btn');
    const currentYearSpan = document.getElementById('current-year');

    // --- State Variables ---
    let audioData = [];
    let currentlyPlayingCard = null;
    let previousVolume = 1;

    // --- Initial Setup ---
    playerContainer.classList.add('hidden'); // Keep hidden initially
    playPauseBtn.setAttribute('aria-label', 'تشغيل');
    if(currentYearSpan) currentYearSpan.textContent = new Date().getFullYear();

    // --- Skeleton Loader Functions ---
    function createSkeletonCard() {
        const card = document.createElement('div');
        card.className = 'skeleton-card';
        card.innerHTML = `
            <div class="skeleton-line title"></div>
            <div class="skeleton-line meta"></div>
            <div class="skeleton-line meta short"></div>
            <div class="skeleton-line meta"></div>
            <div>
                <div class="skeleton-line button"></div>
                <div class="skeleton-line button"></div>
            </div>
        `;
        return card;
    }

    function showSkeletonLoaders(count = 6) {
        loadingContainer.innerHTML = ''; // Clear previous skeletons
        loadingContainer.style.display = 'grid'; // Ensure display is grid
        loadingContainer.classList.add('skeleton-active');
        content.style.display = 'none'; // Hide actual content area
        for (let i = 0; i < count; i++) {
            loadingContainer.appendChild(createSkeletonCard());
        }
    }

    function hideSkeletonLoaders() {
        loadingContainer.innerHTML = '';
        loadingContainer.style.display = 'none';
        loadingContainer.classList.remove('skeleton-active');
        content.style.display = 'grid'; // Show content area
    }

    // --- Data Loading ---
    function loadAudioData() {
        showSkeletonLoaders(); // Show skeletons before fetching

        fetch('./data.json') // Ensure data.json path is correct
          .then(res => {
            if (!res.ok) {
              throw new Error(`خطأ HTTP: ${res.status}`);
            }
            return res.json();
          })
          .then(data => {
            audioData = data;
            updateFilters(data);
            applyFiltersAndDisplay(); // Display initial items respecting filters
          })
          .catch(error => {
            console.error("فشل تحميل البيانات:", error);
            content.innerHTML = `<div class="empty-state"><i class="fas fa-exclamation-triangle"></i><p>حدث خطأ أثناء تحميل البيانات (${error.message}).</p></div>`;
          })
          .finally(() => {
            hideSkeletonLoaders(); // Hide skeletons after success or error
          });
    }

    // --- Update Filters ---
    function updateFilters(data) {
      // Update Districts Filter
      const districts = [...new Set(data.map(item => item.district).filter(Boolean))].sort();
      const districtFilter = document.getElementById('districtFilter');
      districtFilter.innerHTML = '<option value="">كل المديريات</option>';
      districts.forEach(district => {
        const option = document.createElement('option');
        option.value = district;
        option.textContent = district;
        districtFilter.appendChild(option);
      });

      // Update Mosques Filter
      const mosques = [...new Set(data.map(item => item.mosque).filter(Boolean))].sort();
      const mosqueFilter = document.getElementById('mosqueFilter');
      mosqueFilter.innerHTML = '<option value="">كل المساجد</option>';
      mosques.forEach(mosque => {
        const option = document.createElement('option');
        option.value = mosque;
        option.textContent = mosque;
        mosqueFilter.appendChild(option);
      });
    }

    // --- Display Items ---
    function displayItems(items) {
      content.innerHTML = ''; // Clear previous items
      if (items.length === 0) {
          content.innerHTML = `<div class="empty-state"><i class="fas fa-box-open"></i><p>لا توجد مواد صوتية تطابق بحثك أو الفلترة المحددة.</p></div>`;
          return;
      }
      items.forEach((item, index) => {
        const card = createCard(item, index); // Pass index for potential ID
        content.appendChild(card);
        // Staggered fade-in animation with improved timing and effect
        setTimeout(() => {
          if (card) { // Check if card still exists
            card.style.opacity = 1;
            card.style.transform = 'translateY(0) scale(1)';
            // Add a subtle floating animation after cards appear
            if (index % 2 === 0) {
              card.style.animation = 'float 4s ease-in-out infinite';
              card.style.animationDelay = (index * 0.2) + 's';
            }
          }
        }, 80 * index); // Slightly slower stagger for more noticeable effect
      });
    }

    // --- Create Card Element ---
    function createCard(item, index) {
      const card = document.createElement('div');
      card.className = 'card';
      card.id = `card-${index}`; // Assign unique ID
      card.style.opacity = 0;
      card.style.transform = 'translateY(25px) scale(0.95)';
      card.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';

      // Add category class for styling
      const categoryClass = item.category ? `category-${item.category.replace(/\s+/g, '-')}` : 'category-undefined'; // Handle spaces and undefined
      card.classList.add(categoryClass.toLowerCase());

      // Sanitize data
      const title = item.title || 'عنوان غير متوفر';
      const district = item.district || 'مديرية غير محددة'; // Use district instead of center
      const mosque = item.mosque || 'مسجد غير محدد'; // Added mosque field
      const category = item.category || 'قسم غير محدد';
      const speaker = item.speaker || ''; // Default to empty string if missing
      const date = item.date ? formatDate(item.date) : 'تاريخ غير محدد';
      const duration = item.duration || ''; // Default to empty string
      const audioSrc = item.audio || '';

      card.innerHTML = `
        <h2 id="title-${index}"></h2>
        <div class="card-meta">
          <p><i class="fas fa-map-marker-alt"></i> ${district}</p> <p><i class="fas fa-mosque"></i> ${mosque}</p>
          <p><i class="fas fa-folder-open"></i> ${category}</p>
          ${speaker ? `<p><i class="fas fa-user-tie"></i> ${speaker}</p>` : ''}
          ${duration ? `<p><i class="fas fa-clock"></i> ${duration}</p>` : ''}
          <p><i class="fas fa-calendar-alt"></i> ${date}</p>
        </div>
        <div class="audio-controls">
          <button ${!audioSrc ? 'disabled' : ''} data-index="${index}" class="play-btn" aria-label="تشغيل ${title}">
            <i class="fas fa-play"></i><span class="btn-text">تشغيل</span>
          </button>
          <button class="share-btn ${!audioSrc ? 'disabled' : ''}" 
             onclick="shareAudio('${audioSrc}', '${title}')"
             aria-label="مشاركة ${title}" ${!audioSrc ? 'disabled' : ''}>
            <i class="fas fa-share-alt"></i><span class="btn-text">مشاركة</span>
          </button>
          <button class="download-btn ${!audioSrc ? 'disabled' : ''}"
             onclick="downloadAudio('${audioSrc}', '${title}')"
             aria-label="تحميل ${title}" ${!audioSrc ? 'disabled' : ''}>
            <i class="fas fa-download"></i><span class="btn-text">تحميل</span>
          </button>
        </div>
      `;
      
      // إضافة تأثير الكتابة لعنوان الملف الصوتي بعد إنشاء البطاقة
      setTimeout(() => {
        const titleElement = card.querySelector(`#title-${index}`);
        if (titleElement) {
          new Typed(titleElement, {
            strings: [title],
            typeSpeed: 50,
            showCursor: false,
            startDelay: index * 100, // تأخير متدرج حسب ترتيب البطاقة
          });
        }
      }, 100);
      
      return card;

        // Add event listener to the play button on this specific card
        const playButton = card.querySelector('.play-btn');
        if (playButton) {
            playButton.onclick = () => {
                if (audioSrc) {
                    playAudio(audioSrc, title, district + ' - ' + mosque, card); // Pass card element and combined district/mosque
                }
            };
        }

      return card;
    }

    // --- Format Date ---
    function formatDate(dateStr) {
        try {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return 'تاريخ غير صالح';
            return new Intl.DateTimeFormat('ar-SA', { year: 'numeric', month: 'long', day: 'numeric' }).format(date);
        } catch (e) {
            console.error("Error formatting date:", dateStr, e);
            return 'تاريخ غير محدد';
        }
    }

    // --- Format Time ---
    function formatTime(seconds) {
        const time = Math.round(seconds || 0);
        const hours = Math.floor(time / 3600);
        const minutes = Math.floor((time % 3600) / 60);
        const secs = time % 60;
        const paddedSecs = secs.toString().padStart(2, '0');
        const paddedMins = minutes.toString().padStart(2, '0');

        if (hours > 0) {
            return `${hours}:${paddedMins}:${paddedSecs}`;
        } else {
            return `${minutes}:${paddedSecs}`;
        }
    }

    // --- Update Playing Card UI ---
    function updateCardPlayingState(targetCard, isPlaying) {
        // Remove state from previously playing card
        if (currentlyPlayingCard && currentlyPlayingCard !== targetCard) {
            currentlyPlayingCard.classList.remove('is-playing');
            const oldPlayBtn = currentlyPlayingCard.querySelector('.play-btn');
            if (oldPlayBtn) {
                oldPlayBtn.innerHTML = `<i class="fas fa-play"></i><span class="btn-text">تشغيل</span>`;
                oldPlayBtn.setAttribute('aria-label', `تشغيل ${oldPlayBtn.closest('.card')?.querySelector('h2')?.textContent || ''}`);
            }
        }

        // Update the target card
        const playBtn = targetCard?.querySelector('.play-btn');
        if (targetCard && playBtn) {
            if (isPlaying) {
                targetCard.classList.add('is-playing');
                playBtn.innerHTML = `<i class="fas fa-pause"></i><span class="btn-text">إيقاف</span>`; // Or fa-volume-up
                 playBtn.setAttribute('aria-label', `إيقاف ${targetCard.querySelector('h2')?.textContent || ''}`);
                currentlyPlayingCard = targetCard;
            } else {
                targetCard.classList.remove('is-playing');
                playBtn.innerHTML = `<i class="fas fa-play"></i><span class="btn-text">تشغيل</span>`;
                 playBtn.setAttribute('aria-label', `تشغيل ${targetCard.querySelector('h2')?.textContent || ''}`);
                if (currentlyPlayingCard === targetCard) {
                    currentlyPlayingCard = null;
                }
            }
        } else if (!isPlaying && currentlyPlayingCard){ // Handle stop/end when targetCard is null
             currentlyPlayingCard.classList.remove('is-playing');
             const oldPlayBtn = currentlyPlayingCard.querySelector('.play-btn');
             if (oldPlayBtn) {
                oldPlayBtn.innerHTML = `<i class="fas fa-play"></i><span class="btn-text">تشغيل</span>`;
                 oldPlayBtn.setAttribute('aria-label', `تشغيل ${oldPlayBtn.closest('.card')?.querySelector('h2')?.textContent || ''}`);
            }
             currentlyPlayingCard = null;
        }
    }


    // --- Audio Playback ---
    function playAudio(src, title, center, cardElement) {
      if (!src || src === '#') return;

      // Stop previous audio if any is playing (important!)
      if (!audioPlayer.paused) {
        audioPlayer.pause();
        // updateCardPlayingState might be called again later, but good to reset previous card state here too
         if(currentlyPlayingCard && currentlyPlayingCard !== cardElement) {
            updateCardPlayingState(null, false); // Reset previous card explicitly
         }
      }


      audioPlayer.src = src;
      currentAudioTitle.textContent = title;
      currentAudioCenter.textContent = center;
      playerContainer.classList.remove('hidden');

      playerContainer.dataset.currentSrc = src;
      playerContainer.dataset.currentTitle = title;

      // Reset UI elements
      progressBar.style.width = '0%';
      progressContainer.setAttribute('aria-valuenow', '0');
      currentTimeSpan.textContent = formatTime(0);
      durationSpan.textContent = formatTime(0);
      playPauseBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      playPauseBtn.setAttribute('aria-label', 'جاري التحميل');
      playPauseBtn.disabled = true;

      // --- Player Event Handlers (defined inside playAudio to capture scope if needed, or outside if static) ---
      const handlePlay = () => {
        audioPlayer.play().then(() => {
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            playPauseBtn.setAttribute('aria-label', 'إيقاف مؤقت');
            playPauseBtn.disabled = false;
            updateCardPlayingState(cardElement, true);
        }).catch(error => {
            console.error("Error playing audio:", error);
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            playPauseBtn.setAttribute('aria-label', 'تشغيل');
            playPauseBtn.disabled = false;
            updateCardPlayingState(cardElement, false);
            // Maybe show an error message to the user in the player
        });
      };

      const handlePause = () => {
        audioPlayer.pause();
        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
        playPauseBtn.setAttribute('aria-label', 'تشغيل');
        playPauseBtn.disabled = false;
        updateCardPlayingState(cardElement, false); // Update card state on pause
      };

      // Assign event listeners (overwrite previous ones)
      audioPlayer.onloadedmetadata = () => {
          durationSpan.textContent = formatTime(audioPlayer.duration);
          progressContainer.setAttribute('aria-valuemax', audioPlayer.duration);
          handlePlay(); // Attempt to play
      };

      audioPlayer.ontimeupdate = () => {
        if (audioPlayer.duration) {
            const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            progressBar.style.width = `${progress}%`;
            currentTimeSpan.textContent = formatTime(audioPlayer.currentTime);
            progressContainer.setAttribute('aria-valuenow', audioPlayer.currentTime);
        }
      };

      audioPlayer.onended = () => {
          handlePause(); // Set button to play
          updateCardPlayingState(null, false); // Reset card state on end
          // Optional: Play next track if playlist feature exists
      };

      audioPlayer.onerror = (e) => {
          console.error("Audio player error:", e);
          handlePause(); // Set to play state
          currentAudioTitle.textContent = "خطأ في تحميل الصوت";
          currentAudioCenter.textContent = "تأكد من صحة الرابط أو اتصال الإنترنت";
          durationSpan.textContent = "0:00";
          updateCardPlayingState(cardElement, false); // Reset card state on error
          
          // عرض رسالة خطأ للمستخدم
          alert("حدث خطأ أثناء تشغيل الملف الصوتي. تأكد من اتصال الإنترنت أو حاول لاحقاً.");
      };

      // Load the audio source - this triggers the events above
      audioPlayer.load();

    } // --- End of playAudio function ---


    // --- Filter Logic ---
    function getFilteredItems() {
        const searchText = searchInput.value.toLowerCase().trim();
        const selectedDistrictValue = districtFilter.value;
        const selectedMosqueValue = mosqueFilter.value;
        const selectedDateValue = dateFilter.value;
        const activeCategoryBtn = document.querySelector('.category-btn.active');
        const selectedCategoryValue = activeCategoryBtn ? (activeCategoryBtn.dataset.category === 'all' ? '' : activeCategoryBtn.dataset.category) : '';

        return audioData.filter(item => {
            const titleMatch = item.title?.toLowerCase().includes(searchText) ?? false;
            const districtMatch = item.district?.toLowerCase().includes(searchText) ?? false;
            const mosqueMatch = item.mosque?.toLowerCase().includes(searchText) ?? false; //Search mosque too
            const speakerMatch = item.speaker?.toLowerCase().includes(searchText) ?? false; // Search speaker too
            const searchOk = searchText === '' || titleMatch || districtMatch || mosqueMatch || speakerMatch;

            const districtOk = !selectedDistrictValue || item.district === selectedDistrictValue;
            const mosqueOk = !selectedMosqueValue || item.mosque === selectedMosqueValue;
            const categoryOk = !selectedCategoryValue || item.category === selectedCategoryValue;
            const dateOk = !selectedDateValue || isWithinDateRange(item.date, selectedDateValue);

            return searchOk && districtOk && mosqueOk && categoryOk && dateOk;
        });
    }

    function applyFiltersAndDisplay() {
        const filtered = getFilteredItems();
        displayItems(filtered);
    }

    // --- Date Range Check ---
    function isWithinDateRange(dateStr, range) {
      if (!dateStr) return false;
      try {
          const itemDate = new Date(dateStr);
          if (isNaN(itemDate.getTime())) return false;
          const now = new Date();
          const oneDay = 24 * 60 * 60 * 1000;

          switch(range) {
            case 'week': return now - itemDate <= 7 * oneDay;
            case 'month': return now - itemDate <= 30 * oneDay; // Approx.
            case 'year': return now - itemDate <= 365 * oneDay;
            default: return true;
          }
      } catch (e) {
          console.error("Error checking date range:", dateStr, range, e);
          return false;
      }
    }

    // --- Event Listeners ---

    // Filter listeners
    searchInput.addEventListener('input', applyFiltersAndDisplay);
    districtFilter.addEventListener('change', applyFiltersAndDisplay);
    mosqueFilter.addEventListener('change', applyFiltersAndDisplay);
    dateFilter.addEventListener('change', applyFiltersAndDisplay);

    // Category button listeners
    categoryButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        categoryButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        applyFiltersAndDisplay();
      });
    });

    // --- Player Control Event Listeners ---
    playPauseBtn.onclick = () => {
        if (!audioPlayer.src) return; // Do nothing if no src loaded
        if (audioPlayer.paused) {
            audioPlayer.play().then(() => updateCardPlayingState(currentlyPlayingCard, true)).catch(e=>console.error(e));
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            playPauseBtn.setAttribute('aria-label', 'إيقاف مؤقت');
        } else {
            audioPlayer.pause();
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            playPauseBtn.setAttribute('aria-label', 'تشغيل');
            updateCardPlayingState(currentlyPlayingCard, false);
        }
    };

    forwardBtn.onclick = () => {
        if (audioPlayer.duration) {
            audioPlayer.currentTime = Math.min(audioPlayer.currentTime + 10, audioPlayer.duration);
        }
    };

    backwardBtn.onclick = () => {
        if (audioPlayer.duration) {
            audioPlayer.currentTime = Math.max(audioPlayer.currentTime - 10, 0);
        }
    };

    downloadBtnPlayer.onclick = () => {
        const currentSrc = playerContainer.dataset.currentSrc;
        const currentTitle = playerContainer.dataset.currentTitle;
        if (currentSrc && currentSrc !== '#' && currentTitle) {
            const link = document.createElement('a');
            link.href = currentSrc;
            link.download = `${currentTitle}.mp3`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } else {
            alert("لا يوجد مقطع صوتي حالي للتحميل.");
        }
    };

    // Progress bar seeking (RTL adjusted)
    progressContainer.onclick = (e) => {
        if (audioPlayer.duration) {
            const rect = progressContainer.getBoundingClientRect();
            if (rect.width > 0) {
                 const pos = Math.max(0, Math.min(1, (rect.right - e.clientX) / rect.width));
                 audioPlayer.currentTime = pos * audioPlayer.duration;
            }
        }
    };
     // Accessibility for progress bar seeking with keyboard
    progressContainer.onkeydown = (e) => {
         if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
             e.preventDefault(); // Prevent page scroll
              if (audioPlayer.duration) {
                   const step = e.key === 'ArrowRight' ? -5 : 5; // Adjust step for RTL seeking
                   audioPlayer.currentTime = Math.max(0, Math.min(audioPlayer.duration, audioPlayer.currentTime + step));
              }
         }
    };


    // Volume Control Listeners
    volumeSlider.oninput = () => {
        const volumeValue = volumeSlider.value / 100;
        audioPlayer.volume = volumeValue;
        audioPlayer.muted = false; // Unmute when slider is used
        // Update icon based on volume level
        if (volumeValue === 0) {
            muteBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
            muteBtn.setAttribute('aria-label', 'إلغاء كتم الصوت');
        } else if (volumeValue < 0.5) {
            muteBtn.innerHTML = '<i class="fas fa-volume-down"></i>';
             muteBtn.setAttribute('aria-label', 'كتم الصوت');
        } else {
            muteBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
             muteBtn.setAttribute('aria-label', 'كتم الصوت');
        }
    };

    muteBtn.onclick = () => {
        if (audioPlayer.muted) {
            audioPlayer.muted = false;
            volumeSlider.value = previousVolume * 100; // Restore slider
             // Restore appropriate icon based on restored volume
            if (previousVolume === 0) {
                 muteBtn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                 muteBtn.setAttribute('aria-label', 'إلغاء كتم الصوت');
            } else if (previousVolume < 0.5) {
                 muteBtn.innerHTML = '<i class="fas fa-volume-down"></i>';
                  muteBtn.setAttribute('aria-label', 'كتم الصوت');
            } else {
                 muteBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
                  muteBtn.setAttribute('aria-label', 'كتم الصوت');
            }
        } else {
            previousVolume = audioPlayer.volume; // Store current volume
            audioPlayer.muted = true;
            volumeSlider.value = 0; // Set slider to 0
            muteBtn.innerHTML = '<i class="fas fa-volume-mute"></i>'; // Mute icon
             muteBtn.setAttribute('aria-label', 'إلغاء كتم الصوت');
        }
    };

    // Close player button
    closePlayerBtn.onclick = () => {
        playerContainer.classList.add('hidden');
        if (!audioPlayer.paused) {
            audioPlayer.pause(); // Pause audio when closing player
             playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
             playPauseBtn.setAttribute('aria-label', 'تشغيل');
             updateCardPlayingState(null, false); // Reset card state
        }
    };

    // --- Share Function ---
    async function shareAudio(audioSrc, title) {
        if (!audioSrc || audioSrc === '#') return;

        if (navigator.share) {
            try {
                await navigator.share({
                    title: title,
                    text: `استمع إلى "${title}" في المكتبة الصوتية الدعوية`,
                    url: audioSrc
                });
            } catch (err) {
                console.error('Error sharing:', err);
                // Fallback: Copy to clipboard if sharing fails
                navigator.clipboard.writeText(audioSrc).then(() => {
                    alert('تم نسخ رابط الملف الصوتي');
                });
            }
        } else {
            // Fallback for browsers that don't support sharing
            navigator.clipboard.writeText(audioSrc).then(() => {
                alert('تم نسخ رابط الملف الصوتي');
            });
        }
    }

    // --- Download Function ---
    function downloadAudio(audioSrc, title) {
        if (!audioSrc || audioSrc === '#') return;

        fetch(audioSrc)
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `${title}.mp3`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error("Error downloading audio:", error);
                alert("حدث خطأ أثناء التحميل");
            });
    }

    // --- Load Initial Data ---
    // --- Theme Toggle ---
const themeToggleBtn = document.getElementById('theme-toggle-btn');
const htmlElement = document.documentElement;

// Check for saved theme preference
const savedTheme = localStorage.getItem('theme') || 'light';
htmlElement.setAttribute('data-theme', savedTheme);
updateThemeIcon(savedTheme);

themeToggleBtn.addEventListener('click', () => {
    const currentTheme = htmlElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';

    htmlElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeIcon(newTheme);
});

function updateThemeIcon(theme) {
    themeToggleBtn.innerHTML = theme === 'light' 
        ? '<i class="fas fa-sun"></i>' 
        : '<i class="fas fa-moon"></i>';
    themeToggleBtn.setAttribute('aria-label', 
        theme === 'light' ? 'تفعيل الوضع الداكن' : 'تفعيل الوضع الفاتح'
    );
}

document.addEventListener('DOMContentLoaded', loadAudioData);

  </script>
</body>
</html>